<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>Mini Splatoon TPS – FINAL</title>
<style>
  body{margin:0;background:#111;color:#fff;text-align:center}
  canvas{background:#222;cursor:crosshair;display:block;margin:0 auto}
</style>
</head>
<body>

<h2 id="cd">READY</h2>
<p id="ui"></p>
<canvas id="cv" width="900" height="600"></canvas>

<script>
// ================== 基本 ==================
const cv = document.getElementById("cv");
const ctx = cv.getContext("2d");
const TILE = 10, MAP = 140;

let map = Array.from({length: MAP}, ()=>Array(MAP).fill(0));
let keys = {}, mouse = {x:0,y:0};

// 入力
document.addEventListener("keydown", e=>keys[e.key.toLowerCase()] = true);
document.addEventListener("keyup",   e=>keys[e.key.toLowerCase()] = false);
cv.addEventListener("mousemove", e=>{
  mouse.x = e.offsetX; mouse.y = e.offsetY;
});

// ================== カウントダウン（確実） ==================
let started = false;
let cdStart = null;
const CD_SEC = 3;

function handleCountdown(){
  if(started) return;
  if(cdStart === null){
    cdStart = performance.now();
    document.getElementById("cd").textContent = "READY";
    return;
  }
  const elapsed = (performance.now() - cdStart)/1000;
  const remain = Math.ceil(CD_SEC - elapsed);
  if(remain > 0){
    document.getElementById("cd").textContent = remain;
  }else{
    document.getElementById("cd").textContent = "GO!";
    started = true;
    setTimeout(()=>document.getElementById("cd").textContent="", 600);
  }
}

// ================== エンティティ ==================
const spawnP = {x:15,y:15}, spawnE = {x:120,y:120};

let p = {x:spawnP.x,y:spawnP.y,hp:100,dead:false,cd:0,bomb:0,sp:0,ang:0};
let e = {x:spawnE.x,y:spawnE.y,hp:100,dead:false};

let shots = [], bombs = [];

// ================== 射撃 ==================
cv.addEventListener("click", ()=>{
  if(!started || p.dead || p.cd>0 || keys["shift"]) return;
  const ang = Math.atan2(mouse.y - cv.height/2, mouse.x - cv.width/2);
  shots.push({x:p.x,y:p.y,dx:Math.cos(ang),dy:Math.sin(ang),from:"p"});
  p.cd = 8;
});

// ================== ボム ==================
function throwBomb(who){
  if(who.bomb>0) return;
  bombs.push({x:who.x,y:who.y,t:50,from:(who===p?"p":"e")});
  who.bomb = 180;
}

// ================== スペシャル（スーパー着地） ==================
document.addEventListener("keydown", e=>{
  if(e.key==="e" && p.sp>=100){
    for(let y=-6;y<=6;y++)for(let x=-6;x<=6;x++){
      const px=Math.floor(p.x+x), py=Math.floor(p.y+y);
      if(map[py]?.[px]!=null) map[py][px]=1;
    }
    p.sp = 0;
  }
});

// ================== 衝突（重なり防止） ==================
function collide(a,b,min=0.9){
  const dx=a.x-b.x, dy=a.y-b.y;
  const d=Math.hypot(dx,dy);
  if(d<min && d>0){
    const push=(min-d)/2;
    a.x+=dx/d*push; a.y+=dy/d*push;
    b.x-=dx/d*push; b.y-=dy/d*push;
  }
}

// ================== 更新 ==================
function movePlayer(){
  const spd = keys["shift"] ? 0.16 : 0.10; // イカ高速
  if(keys["w"]) p.y-=spd;
  if(keys["s"]) p.y+=spd;
  if(keys["a"]) p.x-=spd;
  if(keys["d"]) p.x+=spd;
  p.x=Math.max(0,Math.min(MAP-1,p.x));
  p.y=Math.max(0,Math.min(MAP-1,p.y));
}

function updateShots(){
  shots = shots.filter(s=>{
    s.x+=s.dx*0.7; s.y+=s.dy*0.7;
    const t = s.from==="p" ? e : p;
    if(Math.hypot(s.x-t.x,s.y-t.y) < 0.6){
      t.hp -= 25;
      return false;
    }
    return s.x>=0&&s.y>=0&&s.x<MAP&&s.y<MAP;
  });
}

function updateBombs(){
  bombs = bombs.filter(b=>{
    b.t--;
    if(b.t<=0){
      for(let i=0;i<40;i++){
        const ang=Math.random()*Math.PI*2, r=Math.random()*4;
        const ex=b.x+Math.cos(ang)*r, ey=b.y+Math.sin(ang)*r;
        if(map[Math.floor(ey)]?.[Math.floor(ex)]!=null)
          map[Math.floor(ey)][Math.floor(ex)] = b.from==="p"?1:2;
      }
      const t=b.from==="p"?e:p;
      if(Math.hypot(b.x-t.x,b.y-t.y)<4) t.hp-=50;
      return false;
    }
    return true;
  });
}

function respawn(o,sp){
  o.x=sp.x; o.y=sp.y; o.hp=100; o.dead=false;
}

// ================== UI（敵矢印） ==================
function drawArrow(){
  const cx=cv.width/2, cy=cv.height/2;
  const ang=Math.atan2(e.y-p.y, e.x-p.x);
  ctx.save();
  ctx.translate(cx,cy);
  ctx.rotate(ang);
  ctx.fillStyle="yellow";
  ctx.beginPath();
  ctx.moveTo(35,0); ctx.lineTo(15,-6); ctx.lineTo(15,6);
  ctx.closePath(); ctx.fill();
  ctx.restore();
}

// ================== ループ ==================
function loop(){
  handleCountdown();
  ctx.clearRect(0,0,cv.width,cv.height);

  if(started){
    if(!p.dead){
      movePlayer();
      p.ang = Math.atan2(mouse.y - cv.height/2, mouse.x - cv.width/2);
      map[Math.floor(p.y)][Math.floor(p.x)] = 1;
      p.sp = Math.min(100, p.sp + 0.05);
      if(keys["q"]) throwBomb(p);
    }
    if(!e.dead){
      // 敵：プレイヤー同速
      e.x += Math.sign(p.x-e.x)*0.10;
      e.y += Math.sign(p.y-e.y)*0.10;
      if(Math.random()<0.01) throwBomb(e);
      map[Math.floor(e.y)][Math.floor(e.x)] = 2;
    }
    collide(p,e);
    updateShots();
    updateBombs();
  }

  if(p.hp<=0 && !p.dead){ p.dead=true; setTimeout(()=>respawn(p,spawnP),2000); }
  if(e.hp<=0 && !e.dead){ e.dead=true; setTimeout(()=>respawn(e,spawnE),2000); }

  // 背後TPSカメラ
  const camX = p.x*TILE - cv.width/2 - Math.cos(p.ang)*40;
  const camY = p.y*TILE - cv.height/2 - Math.sin(p.ang)*40;

  // 描画
  for(let y=0;y<MAP;y++)for(let x=0;x<MAP;x++){
    if(map[y][x]===0) continue;
    ctx.fillStyle = map[y][x]===1 ? "#00aaff" : "#ff5555";
    ctx.fillRect(x*TILE-camX, y*TILE-camY, TILE, TILE);
  }
  ctx.fillStyle="#fff";
  ctx.fillRect(p.x*TILE-camX, p.y*TILE-camY, TILE, TILE);
  ctx.fillStyle="red";
  ctx.fillRect(e.x*TILE-camX, e.y*TILE-camY, TILE, TILE);

  drawArrow();

  p.cd=Math.max(0,p.cd-1);
  p.bomb=Math.max(0,p.bomb-1);

  document.getElementById("ui").textContent =
    `HP:${p.hp}  ボムCT:${p.bomb}  SP:${Math.floor(p.sp)}`;

  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
