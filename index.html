<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Mini Splatoon TPS – FIXED</title>
<style>
  body{margin:0;background:#111;color:#fff;text-align:center}
  canvas{background:#222;cursor:crosshair}
</style>
</head>
<body>

<h3 id="cd">READY</h3>
<p id="ui"></p>
<canvas id="cv" width="900" height="600"></canvas>

<script>
// ===== 基本 =====
const cv=document.getElementById("cv"),ctx=cv.getContext("2d");
const TILE=10, MAP=120;
let map=[...Array(MAP)].map(()=>Array(MAP).fill(0));
let keys={}, mouse={x:0,y:0};
let start=false, countdown=3;

// ===== 入力 =====
document.onkeydown=e=>keys[e.key.toLowerCase()]=true;
document.onkeyup=e=>keys[e.key.toLowerCase()]=false;
cv.onmousemove=e=>{ mouse.x=e.offsetX; mouse.y=e.offsetY; };

// ===== スポーン =====
const spawnP={x:10,y:10}, spawnE={x:100,y:100};

// ===== エンティティ =====
let p={...spawnP,hp:100,cd:0,bomb:0,skill:0,dead:false,ang:0};
let e={...spawnE,hp:100,dead:false};

// ===== 弾・ボム =====
let shots=[], bombs=[];

// ===== カウントダウン =====
let timer=setInterval(()=>{
  document.getElementById("cd").textContent = countdown>0?countdown:"GO!";
  countdown--;
  if(countdown<0){ start=true; document.getElementById("cd").textContent=""; clearInterval(timer); }
},1000);

// ===== 射撃 =====
cv.onclick=()=>{
  if(!start || p.dead || p.cd>0 || keys["shift"]) return;
  const ang=Math.atan2(mouse.y-cv.height/2, mouse.x-cv.width/2);
  shots.push({x:p.x,y:p.y,dx:Math.cos(ang),dy:Math.sin(ang),from:"p"});
  p.cd=8;
};

// ===== ボム =====
function throwBomb(who){
  if(who.bomb>0) return;
  bombs.push({x:who.x,y:who.y,t:50,from:(who===p?"p":"e")});
  who.bomb=180;
}

// ===== スペシャル（スーパー着地）=====
document.addEventListener("keydown",e=>{
  if(e.key==="e" && p.skill>=100){
    for(let y=-6;y<=6;y++)for(let x=-6;x<=6;x++){
      const px=Math.floor(p.x+x), py=Math.floor(p.y+y);
      if(map[py]?.[px]!=null) map[py][px]=1;
    }
    p.skill=0;
  }
});

// ===== 衝突（重なり防止）=====
function collide(a,b,min=0.9){
  const dx=a.x-b.x, dy=a.y-b.y;
  const d=Math.hypot(dx,dy);
  if(d<min){
    const push=(min-d)/2;
    a.x+=dx/d*push; a.y+=dy/d*push;
    b.x-=dx/d*push; b.y-=dy/d*push;
  }
}

// ===== 更新 =====
function movePlayer(){
  const speed = keys["shift"] ? 0.16 : 0.10; // イカ速い
  if(keys["w"]) p.y-=speed;
  if(keys["s"]) p.y+=speed;
  if(keys["a"]) p.x-=speed;
  if(keys["d"]) p.x+=speed;
  p.x=Math.max(0,Math.min(MAP-1,p.x));
  p.y=Math.max(0,Math.min(MAP-1,p.y));
}

function updateShots(){
  shots=shots.filter(s=>{
    s.x+=s.dx*0.7; s.y+=s.dy*0.7;
    const t = s.from==="p"? e : p;
    if(Math.hypot(s.x-t.x,s.y-t.y)<0.6){
      t.hp-=25;
      return false;
    }
    return s.x>=0&&s.y>=0&&s.x<MAP&&s.y<MAP;
  });
}

function updateBombs(){
  bombs=bombs.filter(b=>{
    b.t--;
    if(b.t<=0){
      for(let i=0;i<40;i++){
        const ang=Math.random()*Math.PI*2, r=Math.random()*4;
        const ex=b.x+Math.cos(ang)*r, ey=b.y+Math.sin(ang)*r;
        map[Math.floor(ey)]?.[Math.floor(ex)] = (b.from==="p"?1:2);
      }
      const t=b.from==="p"?e:p;
      if(Math.hypot(b.x-t.x,b.y-t.y)<4) t.hp-=50;
      return false;
    }
    return true;
  });
}

function respawn(o,sp){ o.x=sp.x; o.y=sp.y; o.hp=100; o.dead=false; }

// ===== 描画 =====
function drawArrow(camX,camY){
  const cx=cv.width/2, cy=cv.height/2;
  const ang=Math.atan2(e.y-p.y,e.x-p.x);
  ctx.save();
  ctx.translate(cx,cy);
  ctx.rotate(ang);
  ctx.fillStyle="yellow";
  ctx.beginPath();
  ctx.moveTo(35,0); ctx.lineTo(15,-6); ctx.lineTo(15,6);
  ctx.closePath(); ctx.fill();
  ctx.restore();
}

function loop(){
  ctx.clearRect(0,0,cv.width,cv.height);

  if(start){
    if(!p.dead){
      movePlayer();
      p.ang=Math.atan2(mouse.y-cv.height/2, mouse.x-cv.width/2);
      map[Math.floor(p.y)][Math.floor(p.x)]=1;
      p.skill=Math.min(100,p.skill+0.05);
      if(keys["q"]) throwBomb(p);
    }

    if(!e.dead){
      // 敵速度＝プレイヤー同等
      e.x+=Math.sign(p.x-e.x)*0.10;
      e.y+=Math.sign(p.y-e.y)*0.10;
      if(Math.random()<0.01) throwBomb(e);
      map[Math.floor(e.y)][Math.floor(e.x)]=2;
    }

    collide(p,e);
    updateShots();
    updateBombs();
  }

  if(p.hp<=0&&!p.dead){ p.dead=true; setTimeout(()=>respawn(p,spawnP),2000); }
  if(e.hp<=0&&!e.dead){ e.dead=true; setTimeout(()=>respawn(e,spawnE),2000); }

  // 背後TPSカメラ
  const camX=p.x*TILE-cv.width/2-Math.cos(p.ang)*40;
  const camY=p.y*TILE-cv.height/2-Math.sin(p.ang)*40;

  // フィールド
  for(let y=0;y<MAP;y++)for(let x=0;x<MAP;x++){
    if(map[y][x]===0) continue;
    ctx.fillStyle = map[y][x]===1? "#00aaff":"#ff5555";
    ctx.fillRect(x*TILE-camX, y*TILE-camY, TILE, TILE);
  }

  // プレイヤー・敵
  ctx.fillStyle="#fff";
  ctx.fillRect(p.x*TILE-camX, p.y*TILE-camY, TILE, TILE);
  ctx.fillStyle="red";
  ctx.fillRect(e.x*TILE-camX, e.y*TILE-camY, TILE, TILE);

  drawArrow(camX,camY);

  p.cd=Math.max(0,p.cd-1);
  p.bomb=Math.max(0,p.bomb-1);

  document.getElementById("ui").textContent =
    `HP:${p.hp} ボムCT:${p.bomb} SP:${Math.floor(p.skill)}`;

  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
